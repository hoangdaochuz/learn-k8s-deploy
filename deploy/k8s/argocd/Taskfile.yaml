version: "3"

tasks:
  install:
    desc: Install ArgoCD in the cluster
    cmds:
      - kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      - kubectl apply -n argocd --server-side -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

  apply-project:
    desc: Apply ArgoCD AppProject
    cmds:
      - kubectl apply -f ./argocd-project.yaml

  apply-apps:
    desc: Apply ArgoCD Applications (staging + production)
    cmds:
      - kubectl apply -f ./argocd-app-staging.yaml
      - kubectl apply -f ./argocd-app-production.yaml

  setup:
    desc: Full ArgoCD setup (install + project + apps)
    cmds:
      - task: install
      - echo "Waiting for ArgoCD to be ready..."
      - kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=120s
      - task: apply-project
      - task: apply-apps

  get-admin-password:
    desc: Get ArgoCD admin initial password
    cmds:
      - kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d && echo

  port-forward:
    desc: Port-forward ArgoCD UI to localhost:9080
    cmds:
      - kubectl port-forward svc/argocd-server -n argocd 9080:443
